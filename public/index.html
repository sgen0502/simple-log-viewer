<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <title>Simpler Log Viewer</title>
    <link rel='stylesheet' href='style.css'>
</head>
<body>
<div class='log-container'>
    <div class='sidebar'>
        <div class='logo'>Simple Log Viewer</div>
        <div id='file-menu' class='menu'></div>
    </div>
    <div class='log-viewer'>
        <div class='log-header'>
            <header>
                <nav>
                    <div class='nav-items'>
                        <div>
                            <input id='watch' type='checkBox'/>
                            <label for="watch">Watch Updates</label>
                            <input id='wrap' type='checkBox'/>
                            <label for="wrap">Wrap Words</label>
                            <button id='refresh'>Refresh</button>
                        </div>
                        <div>
                            <button id='download'>Download</button>
                        </div>
                    </div>
                </nav>
            </header>
        </div>
        <div class='log-entry'>
            <ul id="log-list" class="log-content">
                <pre id='log' class='log-content'>Please click a file on left menu to start.</pre>
            </ul>
        </div>
        <!-- Add more log entries here -->
    </div>
</div>
<script>
    const ids = {
        logBody: 'log-list',
        watchCheck: 'watch',
        wrapCheck: 'wrap',
        refreshBtn: 'refresh',
        downloadBtn: 'download'
    };

    const attribute = {
        dirName: 'dir'
    }

    const classes = {
        menuActive: 'active'
    }

    const commandTypes = {
        getFiles: 'getFiles',
        fileChange: 'file_change',
        watch: 'watch',
        fetch: 'fetch'
    }

    const ws = new WebSocket('ws://' + window.location.host);
    let currentFilePath;
    let currentFileName;

    function menu_onClick(e){
        const menuElements = document.querySelectorAll('#file-menu > a');
        menuElements.forEach(e => e.classList.remove(classes.menuActive))
        e.target.classList.add(classes.menuActive);

        const logElement = document.getElementById(ids.logBody);
        logElement.innerHTML = "";

        currentFileName = e.target.textContent;
        currentFilePath = e.target.getAttribute(attribute.dirName) + e.target.textContent
        const request = {
            type: commandTypes.fileChange,
            data: {
                file: currentFilePath,
                watch: document.getElementById('watch').checked
            }
        }
        ws.send(JSON.stringify(request))
    }

    function watchFileOnChange(e){
        const request = {
            type: commandTypes.watch,
            data: {
                watch: e.target.checked
            }
        }

        ws.send(JSON.stringify(request))
    }

    ws.onmessage = function(event) {
        const response = JSON.parse(event.data);
        if(response.type === 'add'){
            const logElement = document.getElementById(ids.logBody);
            response.data.forEach(text => {
                if(!!text){
                    const dirMenu = document.createElement('li');
                    dirMenu.textContent = text;
                    if(text.toUpperCase().includes("INFO")){
                        dirMenu.classList.add("item-info")
                    }
                    else if(text.toUpperCase().includes("WARNING")){
                        dirMenu.classList.add("item-warning")
                    }
                    else if(text.toUpperCase().includes("ERROR") || text.toUpperCase().includes("EXCEPTION")){
                        dirMenu.classList.add("item-error")
                    }

                    logElement.prepend(dirMenu)
                }
            })
        }
        else if(response.type === commandTypes.getFiles){
            const logElement = document.getElementById('file-menu');
            response.data.forEach(dirAndFiles => {
                const dirMenu = document.createElement('div');
                dirMenu.textContent = dirAndFiles.dir.toString();
                logElement.append(dirMenu);

                dirAndFiles.files.forEach(file => {
                    const newA = document.createElement('a');
                    newA.textContent = file.toString();
                    newA.setAttribute(attribute.dirName, dirAndFiles.dir.toString());
                    newA.onclick = menu_onClick;
                    logElement.append(newA);
                })
            })
        }
    };

    // Event Registering
    document.getElementById(ids.refreshBtn).onclick = function() {
        ws.send(JSON.stringify({type: commandTypes.fetch}));
    };

    document.getElementById(ids.watchCheck).onclick = watchFileOnChange

    document.getElementById(ids.wrapCheck).onclick = function(e) {
        if(e.target.checked)
            document.getElementById(ids.logBody).classList.add('wrapText')
        else
            document.getElementById(ids.logBody).classList.remove('wrapText')
    };

    document.getElementById(ids.downloadBtn).onclick = function(e) {
        const payload = {
            file: currentFilePath
        };

        // Make a POST request using Fetch
        fetch('/download', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(payload)
        })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                return response.blob();
            })
            .then(blob => {
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${new Date().toISOString()}_${currentFileName}`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
            })
            .catch(error => {
                console.error('There was a problem with the fetch operation:', error);
            });
    };
</script>
</body>
</html>
